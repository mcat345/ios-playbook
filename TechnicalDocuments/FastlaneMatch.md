Fastlane Match
==============

Fastlane Match is a tool for managing certificates and provisioning profiles centrally. It downloads certificates and profiles from a GitHub repository or Google Cloud Storage bucket. For safety centrally stored files are encrypted.

Fastlane match [documentation](https://docs.fastlane.tools/actions/match/).

## Several Targets and Types

Best practise for managing different bundle ids is to create one branch for each of them. Default values for the git URL, branch, app identifier and build type are read from the `Matchfile`.

It can happen that code signing certificates for more than one target or type is needed for a build. This can be handled by making several calls to match.

```ruby
match(app_identifier: "com.best.app.ever.seriously", type: "adhoc", git_branch: "best_app_ever_ad_hoc_signing")
match(app_identifier: "com.best.app.ever.seriously", type: "development", git_branch: "best_app_ever_dev_signing")
```

Information about which repository and branches we use for the Babylon apps can be found in our internal Confluence Wiki.

## Update Contents Manually

Fastlane Match provides a utility for nuking all existing certificates and provisioning profiles and replace them with new ones generated by Fastlane Match. This is, however, not always possible. Apple does not allow more than two distribution certificates per account, so it can happen that Fastlane Match cannot create a new distribution certificate and is unable to figure out which existing certificate to link with the provisioning profile. Nuking existing enterprise certificates can be a really bad idea as in house apps will stop working.

Since the files in the GitHub repository are encrypted one cannot update them directly. Fastlane Match provides a couple of helper functions. To clone the repository, open a ruby console and call `Match::GitHelper.clone`. Babylon specific credentials can be found in our 1Password account.

```shell
$ bundle console
irb(main):001:0> require 'match'
=> true
irb(main):002:0> branch = 'build_target'
=> "build_target"
irb(main):003:0> git_url = 'https://github.com/path/to/fastlane/match/repo'
=> "https://github.com/path/to/fastlane/match/repo"
irb(main):004:0> shallow_clone = false
=> false
irb(main):005:0> password = 'long-and-super-secret'
=> "long-and-super-secret"
irb(main):006:0> workspace = Match::GitHelper.clone(git_url, shallow_clone, manual_password: password, branch: branch)
[14:22:10]: Cloning remote git repo…
[14:22:10]: If cloning the repo takes too long, you can use the `clone_branch_directly` option in match.
[14:22:12]: Checking out branch build_target…
[14:22:12]: 🔓  Successfully decrypted certificates repo
=> "/var/folders/8k/r0x0ys_927q8vq5_tq01ntjd2b03m3/T/d20190228-92193-16w4fz2"
```

Open another terminal session and navigate to the folder name returned by `Match::GitHelper.clone`. Once all edits are complete, return to the ruby console.

```shell
irb(main):007:0> commit_message = 'Updated provisioning profiles to be great again.'
=> "Updated provisioning profiles to be great again.”
irb(main):008:> Match::GitHelper.commit_changes(workspace, commit_message, git_url, branch)
[14:28:44]: 🔒  Successfully encrypted certificates repo
[14:28:44]: Pushing changes to remote git repo…
=> nil
```

It can be convenient to store the password in the environment hash

```shell
irb(main):008:> ENV[“MATCH_PASSWORD"] = 'long-and-super-secret'
```

Certificates are stored in three folders

```shell
 certs/development
 certs/distribution
 certs/enterprise
```

It might be necessary to manually make a certificate available in both the enterprise and distribution folder. Copying the files did not work (February 2019), but adding a soft link did.

Fastlane Math expects the filename for the .p12 and .cer to be `certificate id`.p12 and `certificate id`.cer, whereas manually generated certificates that have been downloaded from the developer portal are named `team id`.cer and `team id`.p12.

Fastlane has a utility for interacting with Apple Developer Portal and the App Store Connect API called [spaceship](https://github.com/fastlane/fastlane/tree/master/spaceship). There were some problems (March 2019) with running bundle exec fastlane spaceship. The certificate id can be found by inspecting the certificate in the spaceship playground.

```shell
$ fastlane spaceship
…
Username: apple_developer_id@icloud.com
Logging into to iTunes Connect (apple_developer_id@icloud.com)...
Successfully logged in to iTunes Connect
Logging into the Developer Portal (apple_developer_id@icloud.com)...
Successfully logged in to the Developer Portal
---------------------------------------
| Welcome to the spaceship playground |
---------------------------------------
Enter docs to open up the documentation
Enter exit to exit the spaceship playground
Enter _ to access the return value of the last executed command
Just enter the commands and confirm with Enter
[1] pry(#<Spaceship::Playground>)> certificates = Spaceship::Portal.certificate.all
The current user is in 2 teams. Pass a team ID or call `select_team` to choose a team. Using the first one for now.
=> [<Spaceship::Portal::Certificate::Development
        id="CV89FKERTS",
        name="iOS Development",
        status="Issued",
        created=2018-03-05 20:54:38 UTC,
        expires=2019-03-05 20:44:38 UTC,
        owner_type="teamMember",
        owner_name="Latosius Silversong",
        owner_id="BH9RFFETSAS",
        type_display_id="6FG4WEDART",
        can_download=true>,
...
```

Fastlane Spaceship will prompt for a password if it is not available.
It seems that Fastlane Match cannot always figure out when to re-use an existing certificate (February 2019) for a new provisioning profile.

Provisioning profiles are stored in

```shell
profiles/adhoc
profiles/appstore
profiles/development
profiles/enterprise
```

Fastlane Match requires that provisioning profiles are named AdHoc_`bundle identifier`.mobileprovision, AppStore_`bundle identifier`.mobileprovision, Development_`bundle identifier`.mobileprovision or InHouse_`bundle identifier`.mobileprovision.
